// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Advertiser {
  id        String   @id @default(cuid())
  wallet    String   @unique
  name      String?
  email     String?
  company   String?
  subscriptionPlan String? // basic, premium, enterprise
  subscriptionActive Boolean @default(false)
  subscriptionDate DateTime?
  totalSpent Decimal @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns Campaign[]

  @@map("advertisers")
}

model Publisher {
  id          String   @id @default(cuid())
  wallet      String   @unique
  domain      String   // Deprecated: kept for backwards compatibility
  verified    Boolean  @default(false)
  totalEarned Decimal  @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sites       PublisherSite[]
  events      Event[]
  payouts     Payout[]

  @@map("publishers")
}

model PublisherSite {
  id          String   @id @default(cuid())
  publisherId String
  publisher   Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  domain      String
  siteId      String   @unique // site_${publisher.id}_${index} or similar
  apiKey      String   @unique // API key for SDK authentication (auto-generated)
  apiSecret   String   // Hashed secret for signature verification (never returned to frontend)
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events      Event[]

  @@unique([publisherId, domain])
  @@map("publisher_sites")
}

model Campaign {
  id           String   @id @default(cuid())
  advertiserId String
  advertiser   Advertiser @relation(fields: [advertiserId], references: [id], onDelete: Cascade)
  
  name         String
  description  String?
  bannerUrl    String
  targetUrl    String
  budget        Decimal
  spent         Decimal  @default(0)
  cpc          Decimal  // Cost per click
  active        Boolean  @default(true)
  tokenAddress String?  // ERC20 token address used for payment
  metadataURI   String?  // IPFS URI for additional metadata
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  events Event[]

  @@map("campaigns")
}

model Event {
  id         String   @id @default(cuid())
  type       EventType
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  publisherId String
  publisher  Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  siteId     String? // Optional: can reference PublisherSite.id or be a legacy siteId
  publisherSiteId String? // Optional: reference to PublisherSite
  publisherSite PublisherSite? @relation(fields: [publisherSiteId], references: [id], onDelete: Cascade)
  adId       String
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  
  // For fraud detection
  fingerprint String?
  verified    Boolean @default(false)
  
  @@map("events")
}

model AnalyticsHash {
  id        String   @id @default(cuid())
  date      DateTime
  hash      String   @unique
  createdAt DateTime @default(now())

  @@unique([date])
  @@map("analytics_hashes")
}

enum EventType {
  IMPRESSION
  CLICK
}

model Asset {
  id          String   @id @default(cuid())
  filename    String?
  contentType String
  dataBase64  String   // base64-encoded image data
  createdAt   DateTime @default(now())

  @@map("assets")
}

model Payout {
  id              String   @id @default(cuid())
  publisherId     String
  publisher       Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  publisherWallet String
  amount          Decimal
  proof           String   // bytes32 hash proof for on-chain verification
  date            String   // YYYY-MM-DD format
  status          String   @default("pending") // pending, completed, failed
  txHash          String?  // Transaction hash after execution
  error           String?  // Error message if failed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("payouts")
}

// Debug/Dummy Database - Tracks all SDK interactions and requests
model SdkRequest {
  id          String   @id @default(cuid())
  type        String   // PAGE_LOAD, AD_REQUEST, SITE_DETECT, BEACON, etc.
  endpoint    String   // API endpoint called
  method      String   // GET, POST, etc.
  siteId      String?
  domain      String?
  pageUrl     String?
  userAgent   String?
  ipAddress   String?
  fingerprint String?
  requestBody String?  // JSON string of request body
  responseStatus Int?
  responseBody String? // JSON string of response body
  error       String?
  duration    Int?     // Request duration in ms
  timestamp   DateTime @default(now())
  
  interactions SdkInteraction[]

  @@index([type])
  @@index([timestamp])
  @@index([siteId])
  @@map("sdk_requests")
}

model SdkInteraction {
  id          String   @id @default(cuid())
  requestId   String?
  request     SdkRequest? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  type        String   // IMPRESSION, CLICK, IMAGE_LOAD, VISIBILITY_CHANGE, etc.
  adId        String?
  campaignId  String?
  siteId      String?
  pageUrl     String?
  elementType String?  // BANNER, POPUP, SIDEBAR
  metadata    String?  // JSON string of additional metadata
  timestamp   DateTime @default(now())

  @@index([type])
  @@index([timestamp])
  @@index([adId])
  @@map("sdk_interactions")
}

model ApiRouteCall {
  id          String   @id @default(cuid())
  route       String   // /api/ads, /api/sites/detect, etc.
  method      String   // GET, POST, etc.
  statusCode  Int
  ipAddress   String?
  userAgent   String?
  requestBody String?  // JSON string
  responseBody String? // JSON string (truncated if too long)
  error       String?
  duration    Int?     // Request duration in ms
  timestamp   DateTime @default(now())

  @@index([route])
  @@index([timestamp])
  @@index([statusCode])
  @@map("api_route_calls")
}

model CallbackLog {
  id          String   @id @default(cuid())
  type        String   // BEACON, WEBHOOK, TRACK, etc.
  endpoint    String   // /api/webhook/beacon, etc.
  payload     String   // JSON string of payload
  ipAddress   String?
  userAgent   String?
  fingerprint String?
  statusCode  Int?
  error       String?
  timestamp   DateTime @default(now())

  @@index([type])
  @@index([timestamp])
  @@map("callback_logs")
}
